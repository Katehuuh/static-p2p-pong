
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong P2P - Infinite Rooms</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #222; color: #fff; font-family: sans-serif; text-align: center; margin-top: 50px; }
        #status { font-size: 20px; color: yellow; margin-bottom: 20px; }
        #game-ui { display: none; border: 2px solid white; width: 300px; height: 100px; margin: 0 auto; line-height: 100px; }
    </style>
</head>
<body>

    <h1>Pong Matchmaking</h1>
    <div id="status">Connecting to PeerJS Cloud...</div>
    <div id="game-ui">GAME STARTED</div>
    <div id="logs" style="margin-top:20px; color:#888; font-size:12px;"></div>

    <script>
        const PREFIX = "pong_game_v5_"; // Change v5 to v6 to flush ghosts if needed
        let roomIndex = 1;
        let myPeer = null;

        function log(text) {
            document.getElementById('logs').innerHTML += `<div>${text}</div>`;
        }

        function startMatchmaking() {
            const hostID = `${PREFIX}room_${roomIndex}_host`;
            
            document.getElementById('status').innerText = `Checking Room ${roomIndex}...`;

            // 1. Try to BE the Host
            const peer = new Peer(hostID, {
                debug: 1,
                config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] } 
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    // ID is taken. A host exists (or is a ghost).
                    log(`Room ${roomIndex} Host exists. Trying to join...`);
                    peer.destroy();
                    tryToJoin(hostID);
                } else {
                    log(`PeerJS Error: ${err.type}`);
                }
            });

            peer.on('open', (id) => {
                // We successfully claimed the Host ID. We are Player 1.
                myPeer = peer;
                document.getElementById('status').innerText = `Waiting for Player 2 in Room ${roomIndex}...`;
                log("I am Host.");

                peer.on('connection', (conn) => {
                    log("Player 2 connected!");
                    startGame("HOST", conn);
                });
            });
        }

        function tryToJoin(hostID) {
            // Create a random ID for ourselves (Player 2)
            const peer = new Peer();

            peer.on('open', () => {
                log(`My ID: ${peer.id}. Connecting to ${hostID}...`);
                const conn = peer.connect(hostID, { reliable: true });

                let connected = false;

                conn.on('open', () => {
                    connected = true;
                    startGame("JOINER", conn);
                });

                // GHOST HOST FIX: If we don't connect in 3 seconds, assume room is dead.
                setTimeout(() => {
                    if (!connected) {
                        log(`Room ${roomIndex} timed out (Ghost). Skipping to Room ${roomIndex+1}...`);
                        conn.close();
                        peer.destroy();
                        roomIndex++;
                        startMatchmaking(); // RECURSION: Try next room
                    }
                }, 3000);
            });
            
            peer.on('error', (err) => {
                // If we can't connect, move to next room
                log(`Failed to join Room ${roomIndex}. Next...`);
                roomIndex++;
                startMatchmaking();
            });
        }

        function startGame(role, conn) {
            document.getElementById('status').innerText = `PLAYING! Role: ${role}`;
            document.getElementById('game-ui').style.display = "block";
            document.getElementById('game-ui').style.background = role === "HOST" ? "blue" : "red";
            
            // Your Game Logic Goes Here
            conn.on('data', (data) => {
                console.log("Data received:", data);
            });
        }

        // Start Logic
        startMatchmaking();

    </script>
</body>
</html>
